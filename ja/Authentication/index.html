<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
---
layout: default
---

<div class="docs-container container-fluid">
  <div class="row">
    <nav class="sidebar-nav col-sm-3 col-lg-3">
      <!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<ul class="sidebar">
  
  <section class="sidebar-group">
    <h4>Getting started</h4>
    <ul>
      
      
      
      
      <li><a href="/incubator-pulsar/ja/GettingStarted/"><i class="fa fa-file-text-o"></i>Pulsar入門</a></li>
      
      
      
      
      
      <li><a href="/incubator-pulsar/ja/Architecture/"><i class="fa fa-file-text-o"></i>システム概要</a></li>
      
      
    </ul>
  </section>
  
  <section class="sidebar-group">
    <h4>運用管理</h4>
    <ul>
      
      
      
      
      <li><a href="/incubator-pulsar/ja/ClusterSetup/"><i class="fa fa-file-text-o"></i>クラスタのセットアップ</a></li>
      
      
      
      
      
      <li><a href="/incubator-pulsar/ja/AdminTools/"><i class="fa fa-file-text-o"></i>adminツールとAPI</a></li>
      
      
    </ul>
  </section>
  
</ul>

    </nav>

    <article class="col-sm-7 col-lg-7">
      <section class="docs-header">
        <h1 class="docs-title">Pulsarにおける認証</h1>
        
        <hr />
      </section>

      <section class="content">
        <h2 id="認証モデル">認証モデル</h2>

<p>Pulsarはプラガブル認証メカニズムをサポートし、Brokerは複数の認証ソースをサポートするように設定できます。</p>

<p>認証プロバイダ実装の役割は、 クライアントのアイデンティティを <em>ロール</em> トークンの形式で確立することです。<br />
このロールトークンを使用して、このクライアントが特定のトピックに対してproduceまたはconsumeを許可されているかどうかを検証します。</p>

<h2 id="認証プロバイダ">認証プロバイダ</h2>

<h3 id="tlsクライアント認証">TLSクライアント認証</h3>

<p>PulsarクライアントとBroker間の接続暗号化を提供することに加えて、<br />
TLSは信頼された認証局 (CA) によって署名された証明書を通してクライアントを識別できます。</p>

<p><strong>注</strong>: 他のPulsarコードとは異なり、TLS認証プロバイダはYahooのプロダクションでは使用されていません。<br />
使用する際に発生した問題があれば報告してください。</p>

<h4 id="証明書の作成">証明書の作成</h4>

<h5 id="認証局-ca">認証局 (CA)</h5>

<p>最初のステップは、CAの証明書を作成することです。<br />
CAはBrokerとクライアント両方の証明書に署名するために用いられ、お互いを信頼できるようにします。</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="c"># Linuxシステム上で:</span>
<span class="gp">$ </span>CA.pl -newca

<span class="c"># MacOSX上で</span>
<span class="gp">$ </span>/System/Library/OpenSSL/misc/CA.pl -newca
</code></pre>
</div>

<p>コマンドライン上の質問に回答後、CA関連のファイルが<code class="highlighter-rouge">./demoCA</code>配下に作成されます。</p>
<ul>
  <li><code class="highlighter-rouge">demoCA/cacert.pem</code> は公開鍵証明書です。全ての関係者に配布されます。</li>
  <li><code class="highlighter-rouge">demoCA/private/cakey.pem</code> は秘密鍵です。Brokerまたはクライアントの新規の証明書に署名するときのみ必要になります。安全な場所に保管してください。</li>
</ul>

<h5 id="brokerの証明書">Brokerの証明書</h5>

<p>証明書リクエストを作成し、CAの公開鍵証明書で署名します。</p>

<p>これらのコマンドはいくつかの質問をし、証明書を作成します。<br />
コモンネームは、Brokerのホスト名と一致させる必要があります。<br />
Brokerのホスト名のグループにマッチするワイルドカードを利用することも可能です。<br />
例えば<code class="highlighter-rouge">*.broker.usw.example.com</code>のようにすることで、同じ証明書を複数マシンで再利用できます。</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>openssl req -newkey rsa:2048 -sha256 -nodes -out broker-cert.csr -outform PEM

<span class="c"># 鍵をPKCS#8フォーマットに変換</span>
<span class="gp">$ </span>openssl pkcs8 -topk8 -inform PEM -outform PEM -in privkey.pem -out broker-key.pem -nocrypt
</code></pre>
</div>

<p>このコマンドによりBrokerの証明書リクエストファイル (<code class="highlighter-rouge">broker-cert.csr</code>と<code class="highlighter-rouge">broker-key.pem</code>) が生成されます。</p>

<p>これで署名付き証明書の作成に進むことができます:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>openssl ca -out broker-cert.pem -infiles broker-cert.csr
</code></pre>
</div>

<p>この時点で、Brokerに必要な<code class="highlighter-rouge">broker-cert.pem</code>と<code class="highlighter-rouge">broker-key.pem</code>が用意できました。</p>

<h5 id="クライアントの証明書">クライアントの証明書</h5>

<p>Brokerと同じステップを繰り返して、<code class="highlighter-rouge">client-cert.pem</code> と <code class="highlighter-rouge">client-key.pem</code>を作成してください。</p>

<p>クライアントのコモンネームは、クライアントのホスト名と一致させる必要はありませんが、<br />
<em>ロール</em>トークンで使用予定の文字列を用いる必要があります。</p>

<h4 id="brokerの設定">Brokerの設定</h4>

<p><code class="highlighter-rouge">conf/broker.conf</code>にPulsar BrokerのTLS認証を設定:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nv">tlsEnabled</span><span class="o">=</span><span class="nb">true
</span><span class="nv">tlsCertificateFilePath</span><span class="o">=</span>/path/to/broker-cert.pem
<span class="nv">tlsKeyFilePath</span><span class="o">=</span>/path/to/broker-key.pem
<span class="nv">tlsTrustCertsFilePath</span><span class="o">=</span>/path/to/cacert.pem

<span class="c"># Add TLS auth provider</span>
<span class="nv">authenticationEnabled</span><span class="o">=</span><span class="nb">true
</span><span class="nv">authorizationEnabled</span><span class="o">=</span><span class="nb">true
</span><span class="nv">authenticationProviders</span><span class="o">=</span>org.apache.pulsar.broker.authentication.AuthenticationProviderTls
</code></pre>
</div>

<h4 id="ディスカバリサービスの設定">ディスカバリサービスの設定</h4>

<p>ディスカバリサービスはHTTPSリクエストのリダイレクト処理を行うため、同様にクライアントから信頼される必要があります。<br />
<code class="highlighter-rouge">conf/discovery.conf</code>にTLS認証の設定を追加：</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nv">tlsEnabled</span><span class="o">=</span><span class="nb">true
</span><span class="nv">tlsCertificateFilePath</span><span class="o">=</span>/path/to/broker-cert.pem
<span class="nv">tlsKeyFilePath</span><span class="o">=</span>/path/to/broker-key.pem
</code></pre>
</div>

<h4 id="javaクライアントの設定">Javaクライアントの設定</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">ClientConfiguration</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClientConfiguration</span><span class="o">();</span>
<span class="n">conf</span><span class="o">.</span><span class="na">setUseTls</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">conf</span><span class="o">.</span><span class="na">setTlsTrustCertsFilePath</span><span class="o">(</span><span class="s">"/path/to/cacert.pem"</span><span class="o">);</span>

<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">authParams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">authParams</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"tlsCertFile"</span><span class="o">,</span> <span class="s">"/path/to/client-cert.pem"</span><span class="o">);</span>
<span class="n">authParams</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"tlsKeyFile"</span><span class="o">,</span> <span class="s">"/path/to/client-cert.pem"</span><span class="o">);</span>
<span class="n">conf</span><span class="o">.</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">AuthenticationTls</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">authParams</span><span class="o">);</span>

<span class="n">PulsarClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">PulsarClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
                        <span class="s">"https://my-broker.com:4443"</span><span class="o">,</span> <span class="n">conf</span><span class="o">);</span>
</code></pre>
</div>

<h4 id="cliツールの設定">CLIツールの設定</h4>

<p><code class="highlighter-rouge">pulsar-admin</code>, <code class="highlighter-rouge">pulsar-perf</code>や<code class="highlighter-rouge">pulsar-client</code>のようなコマンドラインツールは設定ファイル<code class="highlighter-rouge">conf/client.conf</code>を利用します。<br />
認証パラメータの追加:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="nv">serviceUrl</span><span class="o">=</span>https://broker.example.com:8443/
<span class="nv">authPlugin</span><span class="o">=</span>org.apache.pulsar.client.impl.auth.AuthenticationTls
<span class="nv">authParams</span><span class="o">=</span>tlsCertFile:/path/to/client-cert.pem,tlsKeyFile:/path/to/client-cert.pem
<span class="nv">useTls</span><span class="o">=</span><span class="nb">true
</span><span class="nv">tlsAllowInsecureConnection</span><span class="o">=</span><span class="nb">false
</span><span class="nv">tlsTrustCertsFilePath</span><span class="o">=</span>/path/to/cacert.pem
</code></pre>
</div>

      </section>
    </article>

    <nav class="toc-bar col-sm-2 col-lg-2">
      <div id="toc"></div>
    </nav>
  </div>
</div>
